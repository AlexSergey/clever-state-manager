/*!
 * banner:
 * clever-state-manager: 0.9.0
 * MIT
 */
!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t():"function"==typeof define&&define.amd?define([],t):"object"==typeof exports?exports.StateManager=t():e.StateManager=t()}(this,function(){return function(e){var t={};function n(i){if(t[i])return t[i].exports;var r=t[i]={i:i,l:!1,exports:{}};return e[i].call(r.exports,r,r.exports,n),r.l=!0,r.exports}return n.m=e,n.c=t,n.d=function(e,t,i){n.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:i})},n.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},n.t=function(e,t){if(1&t&&(e=n(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var i=Object.create(null);if(n.r(i),Object.defineProperty(i,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var r in e)n.d(i,r,function(t){return e[t]}.bind(null,r));return i},n.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return n.d(t,"a",t),t},n.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},n.p="/",n(n.s=3)}([function(e,t,n){
/*!
 * banner:
 * valid-types: 1.0.2
 * A small JS type checker
 * ISC
 */
e.exports=function(e){var t={};function n(i){if(t[i])return t[i].exports;var r=t[i]={i:i,l:!1,exports:{}};return e[i].call(r.exports,r,r.exports,n),r.l=!0,r.exports}return n.m=e,n.c=t,n.d=function(e,t,i){n.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:i})},n.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},n.t=function(e,t){if(1&t&&(e=n(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var i=Object.create(null);if(n.r(i),Object.defineProperty(i,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var r in e)n.d(i,r,function(t){return e[t]}.bind(null,r));return i},n.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return n.d(t,"a",t),t},n.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},n.p="/",n(n.s=0)}([function(e,t){const n=e=>{let t=typeof e;return"object"==typeof e?null===e?t="null":"undefined"!=typeof window&&e instanceof HTMLElement||"[object HTMLDocument]"===e.toString()?t="[object HTMLDocument]"===e.toString()?"document":"dom":Array.isArray(e)?t="array":e instanceof Date?t="date":"number"==typeof e.length&&"object"==typeof e&&!1===Array.isArray(e)&&(t="arguments"):"number"==typeof e?(t="number",isNaN(e)&&"number"==typeof e&&(t="NaN")):"function"==typeof e&&(t="function",e.toString)&&0===e.toString().indexOf("class")&&(t="class"),t},i=e=>"array"===n(e),r=e=>"string"===n(e),o=e=>"object"===n(e);e.exports={isType:n,isArray:i,isNan:e=>isNaN(e),isString:r,isNumber:e=>"number"===n(e)&&!1===isNaN(e),isBoolean:e=>"boolean"===n(e),isUndefined:e=>"undefined"===n(e),isDefined:e=>void 0!==e,isEmpty:e=>""===e||0===e||"0"===e||null===e||!1===e||!e,isClass:e=>"class"===n(e),isFunction:e=>"function"===n(e),isObject:o,isNull:e=>"null"===n(e),isDOM:e=>"dom"===n(e),isArguments:e=>"arguments"===n(e),isDate:e=>"date"===n(e),isAsync:e=>e instanceof Promise,isUrl:e=>"string"===n(e)&&function(e){return/(ftp|http|https):\/\/(\w+:{0,1}\w*@)?(\S+)(:[0-9]+)?(\/|\/([\w#!:.?+=&%@!\-\/]))?/.test(e)}(e),isBase64:e=>r(e)&&e.indexOf("base64")>=0&&0===e.indexOf("data:"),isEmptyObject:e=>!!o(e)&&0===Object.keys(e).length,isEmptyArray:e=>!!i(e)&&0===e.length}}])},function(e,t,n){
/*!
 * banner:
 * limited-array: 1.0.0
 * Aleksandrov Sergey <gooddev.sergey@gmail.com> (https://github.com/AlexSergey/limited-array)
 * Array with a limit to size. It's very similar to the queue
 * ISC
 */
e.exports=function(e){var t={};function n(i){if(t[i])return t[i].exports;var r=t[i]={i:i,l:!1,exports:{}};return e[i].call(r.exports,r,r.exports,n),r.l=!0,r.exports}return n.m=e,n.c=t,n.d=function(e,t,i){n.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:i})},n.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},n.t=function(e,t){if(1&t&&(e=n(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var i=Object.create(null);if(n.r(i),Object.defineProperty(i,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var r in e)n.d(i,r,function(t){return e[t]}.bind(null,r));return i},n.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return n.d(t,"a",t),t},n.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},n.p="/",n(n.s=0)}([function(e,t,n){"use strict";n.r(t),n.d(t,"default",function(){return i});class i{constructor(e){this.limit=e&&"number"==typeof e.limit?Math.abs(e.limit):10,this.data=[]}setLimit(e){return this.limit=e&&"number"==typeof e?Math.abs(e):this.limit,this.checkLimit()}checkLimit(){let e=this.data.length-this.limit;return!(e<=0||(Array(e).fill(0).forEach(()=>{this.data.shift()}),0))}add(e){return this.data.push(e),this.checkLimit()}splice(e,t){this.data.splice(e,t)}getData(){return this.data.map(e=>e)}at(e){return this.data[e]}getLength(){return this.data.length}reset(){this.data=[]}}}])},function(e,t,n){
/*!
 * banner:
 * @alexsergey/async-loop: 1.0.0
 * Aleksandrov Sergey <gooddev.sergey@gmail.com> (https://github.com/AlexSergey/async-loop)
 * Async loop and inverse async loop
 * ISC
 */
e.exports=function(e){var t={};function n(i){if(t[i])return t[i].exports;var r=t[i]={i:i,l:!1,exports:{}};return e[i].call(r.exports,r,r.exports,n),r.l=!0,r.exports}return n.m=e,n.c=t,n.d=function(e,t,i){n.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:i})},n.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},n.t=function(e,t){if(1&t&&(e=n(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var i=Object.create(null);if(n.r(i),Object.defineProperty(i,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var r in e)n.d(i,r,function(t){return e[t]}.bind(null,r));return i},n.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return n.d(t,"a",t),t},n.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},n.p="/",n(n.s=0)}([function(e,t,n){"use strict";n.r(t),n.d(t,"asyncLoop",function(){return r}),n.d(t,"inverseAsyncLoop",function(){return o});var i=n(1);const r=(e,t,n)=>{if(!Object(i.isArray)(e))return!1;let r=e.length;if(0===r)return!1;let o=0,s=!1,u={next:function(){if(!s)if(o<r){o++;let n=e[u.iteration()];t(n,u)}else s=!0,Object(i.isFunction)(n)&&n()},iteration:function(){return o-1},break:function(){s=!0,Object(i.isFunction)(n)&&n()}};return u.next(),u},o=(e,t,n)=>{if(!Object(i.isArray)(e))return!1;let r=e.length;if(0===r)return!1;let o=r+1,s=!1,u={next:function(){if(!s)if(0===o)s=!0,Object(i.isFunction)(n)&&n();else{o--;let n=e[u.iteration()];t(n,u)}},iteration:function(){return o-1},break:function(){s=!0,Object(i.isFunction)(n)&&n()}};return u.next(),u}},function(e,t,n){
/*!
 * banner:
 * valid-types: 1.0.2
 * A small JS type checker
 * ISC
 */
e.exports=function(e){var t={};function n(i){if(t[i])return t[i].exports;var r=t[i]={i:i,l:!1,exports:{}};return e[i].call(r.exports,r,r.exports,n),r.l=!0,r.exports}return n.m=e,n.c=t,n.d=function(e,t,i){n.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:i})},n.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},n.t=function(e,t){if(1&t&&(e=n(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var i=Object.create(null);if(n.r(i),Object.defineProperty(i,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var r in e)n.d(i,r,function(t){return e[t]}.bind(null,r));return i},n.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return n.d(t,"a",t),t},n.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},n.p="/",n(n.s=0)}([function(e,t){const n=e=>{let t=typeof e;return"object"==typeof e?null===e?t="null":"undefined"!=typeof window&&e instanceof HTMLElement||"[object HTMLDocument]"===e.toString()?t="[object HTMLDocument]"===e.toString()?"document":"dom":Array.isArray(e)?t="array":e instanceof Date?t="date":"number"==typeof e.length&&"object"==typeof e&&!1===Array.isArray(e)&&(t="arguments"):"number"==typeof e?(t="number",isNaN(e)&&"number"==typeof e&&(t="NaN")):"function"==typeof e&&(t="function",e.toString)&&0===e.toString().indexOf("class")&&(t="class"),t},i=e=>"array"===n(e),r=e=>"string"===n(e),o=e=>"object"===n(e);e.exports={isType:n,isArray:i,isNan:e=>isNaN(e),isString:r,isNumber:e=>"number"===n(e)&&!1===isNaN(e),isBoolean:e=>"boolean"===n(e),isUndefined:e=>"undefined"===n(e),isDefined:e=>void 0!==e,isEmpty:e=>""===e||0===e||"0"===e||null===e||!1===e||!e,isClass:e=>"class"===n(e),isFunction:e=>"function"===n(e),isObject:o,isNull:e=>"null"===n(e),isDOM:e=>"dom"===n(e),isArguments:e=>"arguments"===n(e),isDate:e=>"date"===n(e),isAsync:e=>e instanceof Promise,isUrl:e=>"string"===n(e)&&function(e){return/(ftp|http|https):\/\/(\w+:{0,1}\w*@)?(\S+)(:[0-9]+)?(\/|\/([\w#!:.?+=&%@!\-\/]))?/.test(e)}(e),isBase64:e=>r(e)&&e.indexOf("base64")>=0&&0===e.indexOf("data:"),isEmptyObject:e=>!!o(e)&&0===Object.keys(e).length,isEmptyArray:e=>!!i(e)&&0===e.length}}])}])},function(e,t,n){"use strict";n.r(t);var i=n(1),r=n.n(i),o=n(0),s=n(2);var u=(e,t,n)=>{e&&Object(o.isFunction)(e[t])&&Object(o.isString)(n)&&e[t](n)};var a=class{constructor(e){this.limit=e.limit||10,this.idField=e.idField||"instanceID",this.getInstance=Object(o.isFunction)(e.getInstance)?e.getInstance:null,this.onIncrement=e.onIncrement||null,this.onDecrement=e.onDecrement||null,this.onRemoveFirst=e.onRemoveFirst||null,this.logger=e.logger||console,this.allActions=0,this.index=0,this.queue=new r.a({limit:this.limit})}somethingHasBeenChanged(){if(this.index!==this.queue.getLength()){u(this.logger,"info","StateManager.stack|Stack overflow, next items will be deleted");let e=this.queue.getLength(),t=this.index,n=e;this.queue.splice(this.index,e),this.index=this.queue.getLength();let i=this.index,r=this.queue.getLength();Object(o.isFunction)(this.onRemoveFirst)&&this.onRemoveFirst.call(this,t,n,i,r)}}reset(){u(this.logger,"info","StateManager.stack|Reset stack"),this.index=0,this.queue.reset()}_findInstance(e){return!!Object(o.isFunction)(this.getInstance)&&this.getInstance(e)}undo(e){return e=Object(o.isNumber)(e)?Math.abs(e):void 0,new Promise((t,n)=>{if(this.index>0&&!e||e&&e>=0){let i=[],r=[];e?Array.apply(null,Array(e)).forEach(()=>{this.__decrementIndex(),Object(o.isArray)(this.queue.at(this.index).command)?(i.push(this.queue.at(this.index).command.map(e=>e.undo)),Object(o.isFunction)(this.queue.at(this.index).afterAllUndo)&&r.push(this.queue.at(this.index).afterAllUndo)):(i.push(this.queue.at(this.index).command.undo),Object(o.isFunction)(this.queue.at(this.index).afterAllUndo)&&r.push(this.queue.at(this.index).afterAllUndo))}):(this.__decrementIndex(),Object(o.isArray)(this.queue.at(this.index).command)?(i.push(this.queue.at(this.index).command.map(e=>e.undo)),Object(o.isFunction)(this.queue.at(this.index).afterAllUndo)&&r.push(this.queue.at(this.index).afterAllUndo)):(i.push(this.queue.at(this.index).command.undo),Object(o.isFunction)(this.queue.at(this.index).afterAllUndo)&&r.push(this.queue.at(this.index).afterAllUndo))),this._runCommands(i).then(()=>{r.length>0?Object(s.asyncLoop)(r,(e,t)=>{if(Object(o.isFunction)(e)){let i=e();if(Object(o.isAsync)(i))return i.then(t.next).catch(n)}return t.next()},t):t()})}else n()})}__incrementIndex(){this.index++,Object(o.isFunction)(this.onIncrement)&&this.onIncrement(this.index)}__decrementIndex(){this.index--,Object(o.isFunction)(this.onDecrement)&&this.onIncrement(this.index)}redo(e){return e=Object(o.isNumber)(e)?Math.abs(e):void 0,new Promise((t,n)=>{if(this.index>=0&&!e&&this.index<=this.queue.getLength()-1||e&&this.index>=0&&e<=this.queue.getLength()){let i=[],r=[];e?Array.apply(null,Array(e)).forEach(()=>{Object(o.isArray)(this.queue.at(this.index).command)?(i.push(this.queue.at(this.index).command.map(e=>e.redo)),Object(o.isFunction)(this.queue.at(this.index).afterAllRedo)&&r.push(this.queue.at(this.index).afterAllRedo)):(i.push(this.queue.at(this.index).command.redo),Object(o.isFunction)(this.queue.at(this.index).afterAllRedo)&&r.push(this.queue.at(this.index).afterAllRedo)),this.__incrementIndex()}):(Object(o.isArray)(this.queue.at(this.index).command)?(i.push(this.queue.at(this.index).command.map(e=>e.redo)),Object(o.isFunction)(this.queue.at(this.index).afterAllRedo)&&r.push(this.queue.at(this.index).afterAllRedo)):(i.push(this.queue.at(this.index).command.redo),Object(o.isFunction)(this.queue.at(this.index).afterAllRedo)&&r.push(this.queue.at(this.index).afterAllRedo)),this.__incrementIndex()),this._runCommands(i).then(()=>{r.length>0?Object(s.asyncLoop)(r,(e,t)=>{if(Object(o.isFunction)(e)){let i=e();if(Object(o.isAsync)(i))return i.then(t.next).catch(n)}return t.next()},t):t()}).catch(n)}else n()})}_normalize(e){return Object(o.isObject)(e)?e.stateManager?e.stateManager:e:!!Object(o.isArray)(e)&&e.map(e=>e.stateManager?e.stateManager:e)}_validationCommand(e){let t=!1;return Object(o.isObject)(e)&&e.undo&&e.redo&&(t=!0),Object(o.isArray)(e)&&e.filter(e=>e&&e.undo&&e.redo).length>0&&(t=!0),t}saveState(e,t,n){if(e=this._normalize(e),this._validationCommand(e)){this.allActions+=1,this.somethingHasBeenChanged(),this.__incrementIndex();let i=this.queue.add({command:e,afterAllUndo:t,afterAllRedo:n});return i&&this.__decrementIndex(),u(this.logger,"info",`stateManager.saveState|saved${i?" first item deleted":""}`),i}Object(o.isArray)(e)?u(this.logger,"error",`stateManager.saveState|Invalid commands object - "${e.map(e=>Object(o.isObject)(e)?JSON.stringify(e):e).join(", ")}"`):u(this.logger,"error",`stateManager.saveState|Invalid commands object - "${Object(o.isObject)(e)?JSON.stringify(e):e}"`)}getAllActionsCounter(){return this.allActions}_runCommands(e){this.allActions+=1;let t=[],n=this;function i(e){return new Promise((i,r)=>{Object(s.asyncLoop)(e,(e,i)=>{let s=Object(o.isDefined)(e.arguments)?e.arguments:[],u=Object(o.isArray)(s)?s:[s],a=null;if(Object(o.isString)(e.method)){let t=!!Object(o.isString)(n.idField)&&e[n.idField];(a=n._findInstance(t||void 0))&&(e.instance=a)}if(Object(o.isFunction)(e.before)){let t=e.ctx?e.ctx:e.before,n=e.before.call(t,e);Object(o.isAsync)(n)?n.then(c).catch(r):c(n)}else c();function c(...n){let r,s=e.ctx?e.ctx:e.method;if(a)r=a[e.method].apply(s,u.concat(n));else{if(!Object(o.isFunction)(e.method))return!1;r=e.method.apply(s,u.concat(n))}if(!Object(o.isAsync)(r))return i.next();r.then(t=>{if(!Object(o.isFunction)(e.after))return i.next();{let n=e.ctx?e.ctx:e.method,r=e.after.call(n,t,e);if(!Object(o.isAsync)(r))return i.next();r.then(i.next)}}).catch(e=>(e=Object(o.isString)(e)?e:"Cant restore action",t.push(e),i.next()))}},()=>{t.length>0&&u(this.logger,"error",`StateManager.run|${t.reduce((e,t)=>e+=t,"")}`),i()})})}return Object(o.isArray)(e)?new Promise((t,n)=>{Object(s.asyncLoop)(e,(e,t)=>{i(Object(o.isArray)(e)?e:[e]).then(t.next).catch(n)},t)}):"object"==typeof e?i([e]):void 0}};let c=null;class l{constructor(e,t){Object(o.isFunction)(e.undo)&&Object(o.isFunction)(e.redo)||u(t,"error","Editor.extends.stateManager|This is not valid StateManager object"),this.__undo=e.undo,this.__redo=e.redo}saveState(e,t){return e=this.__undo(e),t=this.__redo(t),e.method||e.arguments||(e={arguments:e}),t.method||t.arguments||(t={arguments:t}),!e.method&&Object(o.isString)(this._fnName)&&(e.method=this._fnName),!t.method&&Object(o.isString)(this._fnName)&&(t.method=this._fnName),!(!e.method||!t.method)&&{stateManager:{undo:e,redo:t}}}}const d=e=>(function(t,n,i){let r=i.value,s=Object(o.isObject)(e)?new l(e,c):null;return i.value=function(...e){return s?(s._fnName=r.name,e.push(s),r.apply(this,e)):(u(c,"error","Editor.extends.stateManager|This is not valid StateManager object"),!1)},i});var f=e=>(!c&&Object(o.isObject)(e)&&(c=e.logger||console),d);n.d(t,"StateManager",function(){return a}),n.d(t,"createSave",function(){return f})}])});